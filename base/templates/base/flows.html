{% extends 'main.html' %}
{% load static %}

{% block content %}
    <div class="action-bar">
    <p>الرسائل التلقائية</p>

    <button class="create-button" id="myButton">
        <i class="fa-solid fa-plus"></i>
        <span>انشاء رسالة تلقائية</span>
    </button>
    </div>



    <div class="table-container">
        <div class="table-header">
            <div class="search-container">
            <div class="table-search">
                <input type="text" id="search" placeholder="بحث عن طريق اسم الحملة, الحالة, الوقت">
            </div>
            </div>
        </div>
        <table id="flows-table">
            <thead>
                <tr>
                    <th>الحملة</th>
                    <th>وقت الانشاء</th>
                    <th>الحالة</th>
                    <th>تم الاستلام</th>
                  </tr>
            </thead>
            <tbody id="flows-body">
                <!-- Flow data will be injected here by JavaScript -->
            </tbody>
        </table>
        <div class="pagination-controls">
            <div class="view-per-page">
                <select id="rows-per-page">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="page-buttons">
                <button id="next-page" class="square-button">
                    <i class="fa-solid fa-angle-right"></i>
                </button>
                <button id="prev-page" class="square-button">
                    <i class="fa-solid fa-angle-left"></i>
                </button>
            
            </div>
        </div>

    </div>
    

    




  


    <div id="myPopup" class="popup">
        <div class="popup-content">
            <form id="flowForm" method="post" action="{% url 'flows' %}">
                {% csrf_token %}
                {{ form.as_p }}
                <div class="button-row">
                    <button type="submit" id="saveButton">حفظ</button>
                    <button type="button" id="closePopup">الغاء</button>
                </div>
            </form>
            
        </div>
    </div>

    <div class="recommended-flows">
        <p>الرسائل التلقائية الموصى بها</p>
        <div id="recommended-flows-container" class="recommended-flows-container">
           
            <!-- Suggested Flows will be injected here by JavaScript -->

        </div>
    </div>

    <div id="get-flows-url" data-get-flows-url="{% url 'get_flows' %}"></div>
    <div id="activate-suggested-flow-url" data-activate-suggested-flow-url="{% url 'activate_suggested_flow' 0 %}"></div>


    <script>
    var flowFormActionUrl = '{% url "flows" %}';
    let allFlows = [];
    let currentPage = 1;
    let rowsPerPage = 25;
    let totalFlows = 0;

    document.addEventListener("DOMContentLoaded", function() {

        setupPagination();
        setupSearch()
        fetchAllFlows();



    });

    function openAddPopup() {
        const flowForm = document.getElementById("flowForm");
        if (flowForm) {
            flowForm.reset();  // Resets the form
            flowForm.action = flowFormActionUrl;  // Sets the action URL
            document.getElementById("saveButton").innerText = "حفظ";
            document.getElementById("myPopup").classList.add("show");  // Shows the popup by adding 'show' class
            document.getElementById("myPopup").style.display = "block";  // Ensures popup is visible
        } else {
            console.error("Form not found.");
        }
    }
    
    document.getElementById("myButton").addEventListener("click", openAddPopup);
    
    // Event listener for close button to close popup
    document.getElementById("closePopup").addEventListener("click", function() {
        document.getElementById("myPopup").classList.remove("show");
        document.getElementById("myPopup").style.display = "none";  // Hides the popup by setting display to none
    });
    
    // Event listener to close popup if clicked outside
    window.addEventListener("click", function(event) {
        const popup = document.getElementById("myPopup");
        if (event.target === popup) {
            popup.classList.remove("show");
            popup.style.display = "none";  // Hides the popup when clicked outside
        }
    });
    


    document.addEventListener('click', function(event) {
        const dropdownIcon = event.target.closest('.dropdown-icon');
        if (dropdownIcon) {
            event.stopPropagation(); // Prevent the event from bubbling up
            closeAllDropdowns(); // Close other open dropdowns
            const dropdown = dropdownIcon.querySelector('.dropdown-content');
            dropdown.classList.toggle('show'); // Toggle the dropdown for the clicked icon
        } else {
            closeAllDropdowns(); // Close dropdowns if clicked outside
        }
    });

    document.addEventListener('click', function(event) {
        const dropdownContent = event.target.closest('.dropdown-content');
        if (dropdownContent) {
            event.stopPropagation(); // Prevent closing when clicking inside the dropdown
        }
        });

    // Function to close all dropdowns
    function closeAllDropdowns() {
        const dropdowns = document.querySelectorAll('.dropdown-content');
        dropdowns.forEach(function(dropdown) {
            dropdown.classList.remove('show');
        });
    }

    function setupSearch() {
        const searchInput = document.getElementById('search');
        searchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                currentPage = 1;
                filterFlows();
            }
        });
    }

    function filterFlows() {
        const searchInput = document.getElementById('search').value.toLowerCase();
        const filteredFlows = allFlows.filter(flow =>
            flow.name.toLowerCase().includes(searchInput) ||
            flow.updated_at.toLowerCase().includes(searchInput) ||
            flow.status.toLowerCase().includes(searchInput) ||
            flow.recipients.toString().includes(searchInput)

        );
        totalFlows = filteredFlows.length;
        displayFlows(filteredFlows.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage));
        updatePaginationControls();
    }

    function setupPagination() {
        const rowsPerPageSelect = document.getElementById('rows-per-page');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
    
        rowsPerPageSelect.addEventListener('change', function() {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            filterFlows();
        });
    
        prevPageButton.addEventListener('click', () => changePage(-1));
        nextPageButton.addEventListener('click', () => changePage(1));
    }
    
    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage > 0 && newPage <= Math.ceil(totalFlows / rowsPerPage)) {
            currentPage = newPage;
            filterFlows();
        }
    }
    
    function updatePaginationControls() {
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
    
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage >= Math.ceil(totalFlows / rowsPerPage);
    }


    function fetchAllFlows() {
        const getFlowsUrl = document.getElementById('get-flows-url').dataset.getFlowsUrl;

        fetch(getFlowsUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            allFlows = data.flows;
            totalFlows = data.flows.length;
            displayFlows(data.flows.slice(0, rowsPerPage));
            displaySuggestedFlows(data.suggestions);
            updatePaginationControls();
        })
        .catch(error => {
            console.error('Error fetching flows:', error);
            showError('An error occurred while fetching flows.');
        });
    }

    function displaySuggestedFlows(flows) {
        const recommendedFlowsContainer = document.getElementById('recommended-flows-container');
        recommendedFlowsContainer.innerHTML = '';

        if (flows && flows.length > 0) {
            flows.forEach(flow => {
                const flowCard = document.createElement('div');
                flowCard.className = 'flow-card';
                flowCard.innerHTML = `
                    <div class="flow-card-body">
                        <div class="title-description">
                            <h3>${flow.name}</h3>
                            <p>${flow.description}</p>
                        </div>
                        <div class="flow-card-button">
                            <a href="/activate-suggested-flow/${flow.id}" class="edit-button">تفعيل</a>
                        </div>
                    </div>
                    <div class="flow-card-img">
                        <img src="/static/svgs/${flow.img}" alt="${flow.name}">
                    </div>
                `;
                recommendedFlowsContainer.appendChild(flowCard);
            });
        } else {
            // No recommended flows found
            recommendedFlowsContainer.innerHTML = '<p>لا توجد رسائل تلقائية موصى بها.</p>';
        }
    }

    


    function displayFlows(flows) {
        const flowsBody = document.getElementById('flows-body');
        const flowsTable = document.getElementById('flows-table');

        flowsBody.innerHTML = '';

        if (flows && flows.length > 0) {
            flows.forEach(flow => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${flow.name}</td>
                    <td>${flow.updated_at}</td>
                    <td>${flow.status}</td>
                    <td>${flow.recipients}</td>
                    <td><div class="dropdown-icon">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                                <div class="dropdown-content">
                                    <a href="/flow/${flow.id}/" class="edit-button">تعديل</a>
                                    <a href="/flow/delete/${flow.id}/" class="delete-button">حذف</a>
                                </div>
                            </div>
                    </td>
                `;
                flowsBody.appendChild(row);
            });
            flowsTable.style.display = 'table';
        } else {
            flowsBody.innerHTML = '<tr><td colspan="4">لا توجد حملات</td></tr>';
        }
    }
    </script>

{% endblock %}
