{% extends 'main.html' %}

{% block content %}
  <h2>Create Campaign</h2>


  <div class="popup" id="myPopup">
    <div class="popup-content">
      <form method="POST" id="campaign-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
  
        <!-- Manually render each form field -->
        <div class="form-group">
          {{ form.name.errors }}
          {{ form.name }}
        </div>
  
        <div class="form-group">
          {{ form.scheduled_time.errors }}
          {{ form.scheduled_time }}
        </div>
        
        <div class="form-group">
            {{ form.customers_group.errors }}
            {{ form.customers_group }}
          </div>
    
        <div class="form-group">
          {{ form.msg.errors }}
          {{ form.msg }}
        </div>
  

        <div class="button-row">
          <button type="submit" class="create-button">جدولة</button>
          <button type="button" id="closePopupButton">الغاء</button>
        </div>
      </form>
    </div>
  </div>
  

    <div class="campaign-actions">
        <button class="create-button" onclick=showPopup()>
            <i class="fa-solid fa-plus"></i>
            <span>إنشاء حملة</span>
        </button>
    </div>
    <div class="table-container">
        <div class="table-header">
            <div class="search-container">
            <div class="table-search">
                <input type="text" id="search" placeholder="بحث عن طريق اسم الحملة, الحالة, الوقت">
            </div>
        </div>
        </div>
        <div id="campaigns-loading" style="padding: 1rem;">جاري تحميل الحملات...</div>
        <table id="campaigns-table">
            <thead>
                <tr>
                    <th>الحملة</th>
                    <th>الوقت المجدول</th>
                    <th>الحالة</th>
                    <th>المتجر</th>
                  </tr>
            </thead>
            <tbody id="campaigns-body">
               
            </tbody>
        </table>
        <div class="pagination-controls">
            <div class="view-per-page">
                <select id="rows-per-page">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="page-buttons">
                <button id="next-page" class="square-button">
                    <i class="fa-solid fa-angle-right"></i>
                </button>
                <button id="prev-page" class="square-button">
                    <i class="fa-solid fa-angle-left"></i>
                </button>
            
            </div>
        </div>
    </div>
    <script>
      let allCampaigns = [];
      let currentPage = 1;
      let rowsPerPage = 25;
      let totalCampaigns = 0;

      document.addEventListener('DOMContentLoaded', function() {
        // Attach event listeners
        setupPagination();
        setupSearch();
        fetchAllCampaigns();

    
        // Show popup
        const showPopupButton = document.getElementById('showPopupButton');
        if (showPopupButton) {
            showPopupButton.addEventListener('click', function(event) {
                event.preventDefault();
                showPopup();
            });
        }
    
        // Close popup
        const closePopupButton = document.getElementById('closePopupButton');
        if (closePopupButton) {
            closePopupButton.addEventListener('click', function(event) {
                event.preventDefault();
                closePopup();
            });
        }
    
        // Event delegation for dropdowns
        document.addEventListener('click', function(event) {
            const dropdownIcon = event.target.closest('.dropdown-icon');
            if (dropdownIcon) {
                event.stopPropagation(); // Prevent the event from bubbling up
                closeAllDropdowns(); // Close other open dropdowns
                const dropdown = dropdownIcon.querySelector('.dropdown-content');
                dropdown.classList.toggle('show'); // Toggle the dropdown for the clicked icon
            } else {
                closeAllDropdowns(); // Close dropdowns if clicked outside
            }
        });
    
        // Prevent dropdown click from closing when clicking inside the dropdown itself
        document.addEventListener('click', function(event) {
            const dropdownContent = event.target.closest('.dropdown-content');
            if (dropdownContent) {
                event.stopPropagation(); // Prevent closing when clicking inside the dropdown
            }
        });
    });
      
      // Function to close all dropdowns
      function closeAllDropdowns() {
        const dropdowns = document.querySelectorAll('.dropdown-content');
        dropdowns.forEach(function(dropdown) {
            dropdown.classList.remove('show');
        });
    }
      
    function showPopup(campaignId) {
      const form = document.getElementById('campaign-form');
      const submitButton = document.querySelector('.create-button');
  
      if (campaignId) {
          // Editing mode
          form.action = '/edit_campaign/' + campaignId + '/';
  
          fetch('/get_campaigns/' + campaignId + '/')
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      allCampaigns = data.data;
                      const campaignData = data.data;
  
                      if (campaignData.status === "scheduled") {
                          submitButton.innerText = 'تحديث';
                          submitButton.style.display = ''; // Ensure the button is visible
                          // Make fields editable
                          document.getElementById('id_name').readOnly = false;
                          document.getElementById('id_scheduled_time').readOnly = false;
                          document.getElementById('id_customers_group').readOnly = false;
                          document.getElementById('id_msg').readOnly = false;
                      } else {
                          // Hide the submit button
                          submitButton.style.display = 'none';
                          // Make fields read-only
                          document.getElementById('id_name').readOnly = true;
                          document.getElementById('id_scheduled_time').readOnly = true;
                          document.getElementById('id_customers_group').readOnly = true;
                          document.getElementById('id_msg').readOnly = true;
                      }
  
                      // Populate form fields
                      document.getElementById('id_name').value = campaignData.name;
                      document.getElementById('id_scheduled_time').value = campaignData.scheduled_time;
                      document.getElementById('id_customers_group').value = campaignData.customers_group;
                      document.getElementById('id_msg').value = campaignData.msg;
  
                      // Show the popup
                      document.getElementById("myPopup").style.display = "block";
                      closeAllDropdowns();
                  } else {
                      alert('Failed to load campaign data');
                  }
              });
      } else {
          // Creating mode
          form.action = '{% url "campaigns" %}';
          submitButton.innerText = 'جدولة';
          submitButton.style.display = ''; // Ensure the button is visible
          // Make fields editable
          document.getElementById('id_name').readOnly = false;
          document.getElementById('id_scheduled_time').readOnly = false;
          document.getElementById('id_customers_group').readOnly = false;
          document.getElementById('id_msg').readOnly = false;
          form.reset();
          document.getElementById("myPopup").style.display = "block";
          closeAllDropdowns();
      }
  }
  
      
      // Function to close the popup
      function closePopup() {
        document.getElementById('myPopup').style.display = 'none';
      }
      
      // Search functionality
      function setupSearch() {
        const searchInput = document.getElementById('search');
        if (searchInput) {
          searchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              filterCampaigns(); // Filter campaigns when Enter key is pressed
            }
          });
        }
      }
      
      // Function to filter campaigns based on search input
      function filterCampaigns() {
        const searchInput = document.getElementById('search').value.toLowerCase();
        const rows = document.querySelectorAll('#campaigns-body tr');
        rows.forEach(function(row) {
          const columns = row.querySelectorAll('td');
          let shouldShow = false;
          columns.forEach(function(column) {
            if (column.textContent.toLowerCase().includes(searchInput)) {
              shouldShow = true;
            }
          });
          row.style.display = shouldShow ? '' : 'none'; // Show or hide rows based on search match
        });
      }

      function filterCampaigns() {
        const searchInput = document.getElementById('search').value.toLowerCase();
    
        // Filter campaigns based on the search input
        const filteredCampaigns = allCampaigns.filter(campaign => {
            return campaign.name.toLowerCase().includes(searchInput) ||
                   campaign.store.toLowerCase().includes(searchInput) ||
                   campaign.status.toLowerCase().includes(searchInput) ||
                   campaign.scheduled_time.toLowerCase().includes(searchInput);
        });
    
        totalCampaigns = filteredCampaigns.length;
    
        // Ensure currentPage is within valid range
        const totalPages = Math.ceil(totalCampaigns / rowsPerPage);
        if (currentPage > totalPages) {
            currentPage = totalPages || 1;
        }
    
        // Paginate the filtered campaigns
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedCampaigns = filteredCampaigns.slice(start, end);
    
        displayCampaigns(paginatedCampaigns);
        updatePaginationControls();
    }



      // fetching
      function fetchAllCampaigns() {
        const campaignsUrl = '/get_campaigns/';
    
        fetch(campaignsUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allCampaigns = data.data;
                totalCampaigns = allCampaigns.length;
                filterCampaigns(allCampaigns.slice(0, rowsPerPage)); // Apply pagination immediately
                updatePaginationControls();
            } else {
                showError('Failed to load campaigns.');
            }
        })
        .catch(error => showError('Error fetching campaigns: ' + error));
    }
    

      function displayCampaigns(campaigns) {
        const campaignsBody = document.getElementById('campaigns-body');
        const campaignsTable = document.getElementById('campaigns-table');
        const loadingDiv = document.getElementById('campaigns-loading');
    
        campaignsBody.innerHTML = '';
        loadingDiv.style.display = 'none';
    
        if (campaigns.length > 0) {
          campaigns.forEach(campaign => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${campaign.name}</td>
                  <td>${campaign.scheduled_time}</td>
                  <td>${campaign.status}</td>
                  <td>${campaign.store}</td>
                  <td>
                      <div class="dropdown-icon">
                          <i class="fa-solid fa-ellipsis-vertical"></i>
                              ${campaign.status === "scheduled" ? `
                                  <div class="dropdown-content">
                                    <a href="javascript:void(0);" onclick="showPopup('${campaign.id}');">تعديل</a>
                                    <a href="${campaign.cancel_url}">الغاء</a>
                                  </div>
                              ` : `
                                  <div class="dropdown-content">
                                    <a href="javascript:void(0);" onclick="showPopup('${campaign.id}');">اظهار</a>
                                    <a href="${campaign.delete_url}">حذف</a>
                                  </div>
                              `}
                      </div>
                  </td>
              `;
              campaignsBody.appendChild(row);
          });
          campaignsTable.style.display = 'table';
      } else {
          showError('No campaigns found.');
      }
    }


    function setupPagination() {
      const rowsPerPageSelect = document.getElementById('rows-per-page');
      const prevPageButton = document.getElementById('prev-page');
      const nextPageButton = document.getElementById('next-page');
  
      rowsPerPageSelect.addEventListener('change', function() {
          rowsPerPage = parseInt(this.value);
          currentPage = 1;
          filterCampaigns();
      });
  
      prevPageButton.addEventListener('click', () => changePage(-1));
      nextPageButton.addEventListener('click', () => changePage(1));
  }


    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage > 0 && newPage <= Math.ceil(totalCampaigns  / rowsPerPage)) {
          currentPage = newPage;
          filterCampaigns();
      }
  }

    function updatePaginationControls() {
      const prevPageButton = document.getElementById('prev-page');
      const nextPageButton = document.getElementById('next-page');
  
      prevPageButton.disabled = currentPage === 1;
      nextPageButton.disabled = currentPage >= Math.ceil(totalCampaigns  / rowsPerPage);
    }


  
      </script>
{% endblock %}




