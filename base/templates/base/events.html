{% extends 'main.html' %}

{% block content %}
<h2>My Events</h2>

{% if events %}
    <ul>
    {% for event in events %}
        <li>
            {{ event.event_type.label }}{% if event.subcategory %} - {{ event.get_subcategory_display }}{% endif %}: {{ event.message_template }}
            <button onclick="openEditPopup('{{ event.id }}', '{{ event.event_type.id }}', '{{ event.subcategory }}', '{{ event.message_template|escapejs }}')">Edit</button> | 
            <a href="{% url 'delete_event' event.id %}" onclick="return confirm('Are you sure you want to delete this event?');">Delete</a>
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>You have no events.</p>
{% endif %}

<h2>Create New Event</h2>
<button id="myButton">Add</button>
<div id="myPopup" class="popup">
    <div class="popup-content">
        <form id="eventForm" method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" id="saveButton">Save</button>
        </form>
        <button id="closePopup">Close</button>
    </div>
</div>

<script>
    var order_updated_event_type_id = '{{ order_updated_event_type_id }}';

    function updateSubcategoryVisibility() {
        var eventTypeField = document.getElementById('id_event_type');
        var selectedValue = eventTypeField.value;

        var subcategoryField = document.getElementById('id_subcategory').parentElement;
        if (selectedValue == order_updated_event_type_id) {
            subcategoryField.style.display = 'block';
        } else {
            subcategoryField.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateSubcategoryVisibility();  // Initialize visibility on page load

        var eventTypeField = document.getElementById('id_event_type');
        eventTypeField.addEventListener('change', function() {
            updateSubcategoryVisibility();
        });
    });

    document.getElementById("myButton").addEventListener("click", function() {
        openAddPopup();
    });

    document.getElementById("closePopup").addEventListener("click", function() {
        document.getElementById("myPopup").classList.remove("show");
    });

    window.addEventListener("click", function(event) {
        if (event.target == document.getElementById("myPopup")) {
            document.getElementById("myPopup").classList.remove("show");
        }
    });

    function openAddPopup() {
        document.getElementById("eventForm").reset();
        document.getElementById("eventForm").action = "{% url 'events' %}";
        document.getElementById("saveButton").innerText = "Save";
        document.getElementById("myPopup").classList.add("show");
    }

    function openEditPopup(eventId, eventType, subcategory, messageTemplate) {
        document.getElementById("eventForm").reset();
        document.getElementById("id_event_type").value = eventType;
        document.getElementById("id_subcategory").value = subcategory;
        document.getElementById("id_message_template").value = messageTemplate;
        document.getElementById("eventForm").action = "{% url 'manage_event' 0 %}".replace('0', eventId);
        document.getElementById("saveButton").innerText = "Update";
        updateSubcategoryVisibility();
        document.getElementById("myPopup").classList.add("show");
    }
</script>
{% endblock %}
