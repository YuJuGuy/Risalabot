{% extends 'main.html' %}
{% load static %}
{% block content %}
<div id="content" class="content-container">
    <div class="session-container">
        <div id="whatsapp-details-container" class="details-container" style="display: none;">
            <div id="loading-spinner" class="spinner-container">
                <div class="spinner"></div>
            </div>
            <!-- WhatsApp details will be inserted here by AJAX -->
        </div>
        <div id="qr-code-container" class="qr-code-container" style="display: none;">
            <div id="loading-spinner" class="spinner-container">
                <div class="spinner"></div>
            </div>
            <!-- QR code will be inserted here by AJAX -->
        </div>
    </div>
    <div class="how-to-scan">
        <img src="{% static 'images/scan.gif' %}" alt="scan">
        <ol>
            <li>فتح واتساب على هاتفك</li>
            <li>اضغط على القائمة أو الإعدادات وحدد الأجهزة المرتبطة</li>
            <li>اضغط على ربط جهاز</li>
            <li>قم بتوجيه هاتفك إلى هذه الشاشة لالتقاط الرمز</li>
        </ol>
    </div>
</div>

<script>
    // Check WhatsApp session and handle display
    function checkWhatsAppSession() {
        const detailsContainer = document.getElementById('whatsapp-details-container');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const loadingSpinner = document.getElementById('loading-spinner');
    
        // Show loading spinner
        qrCodeContainer.innerHTML = '';
        detailsContainer.innerHTML = '';
        loadingSpinner.style.display = 'block';
        qrCodeContainer.style.display = 'flex';
        qrCodeContainer.appendChild(loadingSpinner);
    
        fetch("{% url 'manage_whatsapp_session' %}")
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    if (data.qr) {
                        // Show QR code
                        detailsContainer.style.display = 'none';
                        qrCodeContainer.style.display = 'flex';
                        
                        const imgDiv = document.createElement('div');
                        imgDiv.classList.add('image-container');
                        const qrImage = document.createElement('img');
                        qrImage.src = `data:image/png;base64,${data.data.qr}`;
                        qrImage.alt = "QR Code";
                        imgDiv.appendChild(qrImage);
                        qrCodeContainer.appendChild(imgDiv);
    
                        const reloadButton = document.createElement('button');
                        reloadButton.classList.add('reload-button');
                        reloadButton.id = 'reload-button';
                        reloadButton.innerText = 'تحديث';
                        qrCodeContainer.appendChild(reloadButton);
                    } else {
                        // Show WhatsApp details
                        qrCodeContainer.style.display = 'none';
                        detailsContainer.style.display = 'flex';
                        
                        const imgDiv = document.createElement('div');
                        imgDiv.classList.add('image-container');
                        const profileImage = document.createElement('img');
                        profileImage.src = data.data.profile_picture;
                        profileImage.alt = "Profile Picture";
                        imgDiv.appendChild(profileImage);
                        detailsContainer.appendChild(imgDiv);
    
                        const nameElement = document.createElement('p');
                        nameElement.classList.add('nameElement');
                        nameElement.innerText = data.data.name;
                        detailsContainer.appendChild(nameElement);
    
                        const logoutButton = document.createElement('button');
                        logoutButton.classList.add('logout-button');
                        logoutButton.id = 'logout-button';
                        logoutButton.innerText = 'تسجيل الخروج';
                        detailsContainer.appendChild(logoutButton);
                    }
                } else {
                    showMessage(data.message, data.type);
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showMessage('حدث خطأ أثناء الاتصال بالخادم.');
            });
    }
    
    // Event delegation for dynamically created buttons
    function stopWhatsAppSession() {
        // Show loading spinner immediately
        const detailsContainer = document.getElementById('whatsapp-details-container');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        qrCodeContainer.innerHTML = '';
        detailsContainer.innerHTML = '';
        loadingSpinner.style.display = 'block';
        qrCodeContainer.style.display = 'flex';
        qrCodeContainer.appendChild(loadingSpinner);
    
        // Disable all buttons while processing
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => button.disabled = true);
    
        fetch("{% url 'whatsapp_stop' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkWhatsAppSession();
            } else {
                loadingSpinner.style.display = 'none';
                showMessage(data.message, data.type);
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            showMessage('حدث خطأ أثناء الاتصال بالخادم.');
        })
        .finally(() => {
            // Re-enable buttons after operation completes
            buttons.forEach(button => button.disabled = false);
        });
    }
    
    // Event delegation for dynamically created buttons
    document.addEventListener('click', function(event) {
        if (event.target.id === 'reload-button') {
            checkWhatsAppSession();
        } else if (event.target.id === 'logout-button') {
            stopWhatsAppSession();
        }
    });
    
    // Initial check on page load
    checkWhatsAppSession();
    </script>
{% endblock %}
