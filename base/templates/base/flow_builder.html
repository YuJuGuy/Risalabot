{% extends 'main.html' %}
{% load static %}

{% block content %}



<div class="container">
    <!-- List of available steps -->
    <div class="steps-list" id="steps-list">
        <div class="steps-list-header">
            <h3>الإجراءات المتاحة</h3>
        </div>
        {% for action in action_types %}
            <div class="action" data-id="{{ action.id }}" data-action-type="{{ action.name }}">
                <i class="{{ action.icon}}" style="color: #63E6BE;"></i>
                {{ action.label }}
            </div>
        {% endfor %}
    </div>

    <!-- Flow Canvas where steps are added -->
    <div class="canvas">

        <div class="panzoom-container" id="panzoom-container">
                <div class="canvas-drag-drop" id="flow-canvas">
                    <div class="trigger" id="trigger">
                        <h3 id="trigger-name">{{ flow.trigger.name }}</h3>
                    </div>
                
                    <div class="canvas-steps" id="canvas-steps">
                    {% for step in flow_steps %}
                        <div class="step no-pan" data-id="{{ step.id }}" data-action-type="{{ step.action_type.name }}">
                            <i class="{{ step.action_type.icon}}" style="color: #63E6BE;"></i>
                            {{ step.action_type.label }}
                            {% if step.action_type.name == 'sms' %}
                                <div class="step-action" style="display:none">
                                    <textarea class="sms-message">{{ step.text_config.message }}</textarea>
                                </div>

                            {% elif step.action_type.name == 'delay' %}
                                <div class="step-action" style="display:none">
                                    <input type="number" class="delay-time" value="{{ step.time_delay_config.delay_time }}">
                                    <select class="delay-type">
                                        <option value="hours" {% if step.time_delay_config.delay_type == "hours" %}selected{% endif %}>Hours</option>
                                        <option value="days" {% if step.time_delay_config.delay_type == "days" %}selected{% endif %}>Days</option>
                                    </select>
                                </div>

                            {% endif %}

                        </div>
                    {% endfor %}
                    </div>
                    
                </div>
        </div>

        <div class="canvas-controls">
            <button id="zoom-in">+</button>
            <button id="center-canvas">توسيط</button>
            <button id="zoom-out">-</button>
        </div>
    </div>


</div>

<!-- Save Button -->
<div class="form-container">
    <form method="POST" id="flow-form" action="{% url 'flow' flow.id %}">
        {% csrf_token %}
        
        <!-- Include name and trigger fields in the form -->
        <div class="flowform-container">
            <div class="flowform-right">
            <input type="text" id="id_name" name="name" value="{{ form.name.value }}">
            <select id="id_trigger" name="trigger" style="display: none;">
                {% for trigger in triggers %}
                    <option value="{{ trigger.id }}" {% if trigger.id == form.trigger.value %}selected{% endif %}>{{ trigger.name }}</option>
                {% endfor %}
            </select>
            </div>
            <div class="flowform-left">
            <div class="save-buttons">
            <button type="submit" class="save-active-btn" value="active">حفظ وإرسال</button>
            <button type="submit" class="save-draft-btn" value="draft">حفظ كمسودة</button>
            </div>
            </div>

        </div>
        
    </form>
</div>


<div id="action-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close">&times;</span>

        <div id="trigger-fields" style="display:none;">
            <label>المشغل:</label>
            <select id="modal-trigger" class="trigger">
                {% for trigger in triggers %}
                <option value="{{ trigger.id }}" data-description="{{ trigger.description }}" {% if trigger.id == form.trigger.value %}selected{% endif %}>{{ trigger.name }}</option>
                {% endfor %}
            </select>

            <div id="trigger-description" style="display:none;">
            </div>
        </div>

        <!-- SMS Action Fields -->
        <div id="sms-fields" style="display:none;">
            <label>الرسالة:</label>
            <textarea id="modal-sms-message" class="sms-message"></textarea>
        </div>

        <!-- Delay Action Fields -->
        <div id="delay-fields" style="display:none;">
            <label>التأخير:</label>
            <input type="number" id="modal-delay-time" class="delay-time" value="1">
            <select id="modal-delay-type" class="delay-type">
                <option value="hours">ساعات</option>
                <option value="days">أيام</option>
            </select>
        </div>

        <div class="modal-footer">
            <button id="save-action-btn">حفظ</button>
            <button id="delete-step-btn" style="display:none;">حذف</button>
        </div>
    </div>

</div>

<!-- Hidden field to hold the updated trigger -->
<input type="hidden" id="updated-trigger" name="trigger" value="{{ form.trigger.value }}">



<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<script>
var flowCanvas = document.getElementById('flow-canvas');
var panzoomContainer = document.getElementById('panzoom-container');

var startScale = 1; // You can adjust this as needed

// Calculate the center position
var containerWidth = panzoomContainer.offsetWidth;

// Calculate the starting X and Y positions
var startX = -containerWidth * (1 / startScale);

var panzoomInstance = Panzoom(flowCanvas, {
    maxScale: 3,
    minScale: 0.1,
    smoothScroll: false,
    contain: 'outside',
    cursor: 'grab',
    startScale: startScale,
    transformOrigin: { x: 0.5, y: 0.5 },
    excludeClass: 'no-pan',
    startX: startX,

});



// Allow zoom with the mouse wheel
flowCanvas.addEventListener('wheel', panzoomInstance.zoomWithWheel);



document.getElementById('center-canvas').addEventListener('click', function() {
    var containerWidth = panzoomContainer.offsetWidth;

    var contentWidth = flowCanvas.offsetWidth;

    var currentScale = panzoomInstance.getScale();

    if (currentScale < 1) {
        panzoomInstance.pan(-containerWidth/ currentScale, 0, {force:true });
    }
    else {
        panzoomInstance.zoom(1);
        panzoomInstance.pan(-containerWidth , 0, {force:true });
    }
});

document.getElementById('zoom-in').addEventListener('click', function() {
    panzoomInstance.zoomIn();
});

document.getElementById('zoom-out').addEventListener('click', function() {
    panzoomInstance.zoomOut();
});

// Add debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Create a debounced version of updateConnections
const debouncedUpdateConnections = debounce(updateConnections, 100);

// Add listeners for pan and zoom events
flowCanvas.addEventListener('panzoompan', debouncedUpdateConnections);
flowCanvas.addEventListener('panzoomzoom', debouncedUpdateConnections);




// Initialize Sortable.js for the available steps (left list)
new Sortable(document.getElementById('steps-list'), {
    group: { name: 'shared', pull: 'clone', put: false },
    sort: false,
    animation: 150
});

// Initialize Sortable.js for the canvas (right list)
new Sortable(document.getElementById('canvas-steps'), {
    group: { name: 'shared', pull: false, put: true },
    animation: 150,
    onAdd: function (evt) {
        var newStep = evt.item;
        var actionType = newStep.getAttribute('data-action-type');
        newStep.classList.remove('action');
        newStep.classList.add('step', 'no-pan');
        newStep.setAttribute('data-id', '');

        // Add delete button to the step
        document.getElementById('delete-step-btn').onclick = function(e) {
            e.stopPropagation();
            newStep.remove();
            updateConnections();
        };

        if (actionType === 'sms') {
            newStep.innerHTML += `
                 <div class="step-action" style="display:none">
                    <label>Message:</label>
                    <textarea class="sms-message"></textarea>
                </div>
            `;
        } else if (actionType === 'delay') {
            newStep.innerHTML += `
                 <div class="step-action" style="display:none">
                    <label>Delay Time:</label>
                    <input type="number" class="delay-time" value="1">
                    <select class="delay-type">
                        <option value="hours">Hours</option>
                        <option value="days">Days</option>
                    </select>
                </div>
            `;
        }

        updateConnections();
    },
    onEnd: function (evt) {
        updateConnections();
        
    },
    onSort: function (evt) {
        updateConnections();
    }
});

// Modal Handling
var modal = document.getElementById("action-modal");
var smsFields = document.getElementById("sms-fields");
var delayFields = document.getElementById("delay-fields");
var triggerFields = document.getElementById("trigger-fields");
var saveActionBtn = document.getElementById("save-action-btn");
var currentStep = null;

document.getElementById('trigger').addEventListener('click', function() {
    modal.style.display = "block";
    smsFields.style.display = "none";
    delayFields.style.display = "none";
    triggerFields.style.display = "block";


    
    // Hide delete button for trigger
    document.getElementById('delete-step-btn').style.display = 'none';
});

document.getElementById('canvas-steps').addEventListener('click', function(event) {
    if (event.target.closest('.step')) {
        currentStep = event.target.closest('.step');
        var actionType = currentStep.getAttribute('data-action-type');
        modal.style.display = "block";

        // Show delete button in modal for steps
        document.getElementById('delete-step-btn').style.display = 'inline-block';

        if (actionType === 'sms') {
            smsFields.style.display = "block";
            delayFields.style.display = "none";
            triggerFields.style.display = "none";

            document.getElementById('modal-sms-message').value = currentStep.querySelector('.sms-message').value;
        } else if (actionType === 'delay') {
            smsFields.style.display = "none";
            triggerFields.style.display = "none";

            delayFields.style.display = "block";
            document.getElementById('modal-delay-time').value = currentStep.querySelector('.delay-time').value;
            document.getElementById('modal-delay-type').value = currentStep.querySelector('.delay-type').value;
        }
    }
});

document.querySelector(".close").onclick = function() {
    modal.style.display = "none";
};

saveActionBtn.addEventListener('click', function() {
    if (currentStep) {
        var actionType = currentStep.getAttribute('data-action-type');

        if (actionType === 'sms') {
            var updatedMessage = document.getElementById("modal-sms-message").value;
            currentStep.querySelector('.sms-message').value = updatedMessage;
        } else if (actionType === 'delay') {
            var updatedDelayTime = document.getElementById("modal-delay-time").value;
            var updatedDelayType = document.getElementById("modal-delay-type").value;
            currentStep.querySelector('.delay-time').value = updatedDelayTime;
            currentStep.querySelector('.delay-type').value = updatedDelayType;
        }
    } else {
        var updatedTrigger = document.getElementById("modal-trigger").value;
        document.getElementById("updated-trigger").value = updatedTrigger;
        document.getElementById("id_trigger").value = updatedTrigger;
        document.getElementById("trigger-name").textContent = document.getElementById("modal-trigger").selectedOptions[0].textContent;
    }
    modal.style.display = "none";
});

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
};

// Form submission handling
document.getElementById('flow-form').addEventListener('submit', function(e) {
    e.preventDefault();

    var items = document.querySelectorAll('#canvas-steps .step');
    var updatedSteps = [];

    // Capture the button that was clicked
    var clickedButton = e.submitter;
    var status = clickedButton.value;

    items.forEach(function(item, index) {
        var stepId = item.getAttribute('data-id');
        var actionType = item.getAttribute('data-action-type');

        var stepData = {
            step_id: stepId,
            order: index,
            action_type: actionType,
            status: status,
            content: {}
        };

        if (actionType === 'sms') {
            stepData.content.message = item.querySelector('.sms-message').value;
        } else if (actionType === 'delay') {
            stepData.content.delay_time = item.querySelector('.delay-time').value;
            stepData.content.delay_type = item.querySelector('.delay-type').value;
        }

        updatedSteps.push(stepData);
    });

    var formData = new FormData(this);
    formData.append('steps', JSON.stringify(updatedSteps));
    formData.append('status', status);  // Add the status to the form data

    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            console.error('Error saving flow:', data.errors);
            alert('Error saving flow: ' + data.errors);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please try again.');
    });
});

function updateConnections() {
    const canvasSteps = document.getElementById('canvas-steps');
    const steps = [document.getElementById('trigger'), ...canvasSteps.querySelectorAll('.step')];
    
    // Remove existing connections and insert points
    canvasSteps.querySelectorAll('.connection-line, .insert-point').forEach(el => el.remove());

    steps.forEach((step, index) => {
        if (index < steps.length - 1) {
            const nextStep = steps[index + 1];
            
            // Create connection line
            const connection = document.createElement('div');
            connection.className = 'connection-line';
            
            // Position line relative to current step
            connection.style.top = '100%';
            connection.style.left = '50%';
            connection.style.height = `${nextStep.offsetTop - (step.offsetTop + step.offsetHeight)}px`;
            
            step.appendChild(connection);

            // Create insert point
            const insertPoint = document.createElement('div');
            insertPoint.className = 'insert-point';
            
            // Position insert point on the line
            insertPoint.style.top = `${(nextStep.offsetTop - (step.offsetTop + step.offsetHeight)) / 2}px`;
            insertPoint.style.left = '50%';
            insertPoint.style.transform = 'translate(-50%, -50%)';
            
            insertPoint.addEventListener('click', function(e) {
                e.stopPropagation();
                const newStep = document.createElement('div');
                newStep.className = 'step no-pan';
                newStep.setAttribute('data-action-type', 'new');
                newStep.innerHTML = '<p>New Action</p>';
                nextStep.parentNode.insertBefore(newStep, nextStep);
                updateConnections();
            });
            
            connection.appendChild(insertPoint);
        }
    });
}

window.addEventListener('resize', updateConnections);

// After all steps are loaded and panzoom is initialized
updateConnections();

// Add click event listener for the delete button in the modal
document.getElementById('delete-step-btn').addEventListener('click', function() {
    if (currentStep) {
        currentStep.remove();
        updateConnections();
        modal.style.display = "none";
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const triggerSelect = document.getElementById('modal-trigger');
    const triggerDescription = document.getElementById('trigger-description');
    
    // Function to update the description
    function updateDescription() {
        const selectedOption = triggerSelect.options[triggerSelect.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        if (description) {
            triggerDescription.textContent = description;
            triggerDescription.style.display = 'block';
        } else {
            triggerDescription.style.display = 'none';
        }
    }
    
    // Update description on page load
    updateDescription();
    
    // Update description when selection changes
    triggerSelect.addEventListener('change', updateDescription);
});

// Add this at the end of your existing script

document.addEventListener('DOMContentLoaded', function() {
    // Get all links in the document
    var links = document.getElementsByTagName('a');

    // Iterate through all links
    for (var i = 0; i < links.length; i++) {
        links[i].addEventListener('click', function(event) {
            // Check if this link is not a save or draft button
            if (!this.classList.contains('save-active-btn') && !this.classList.contains('save-draft-btn')) {
                // Show confirmation dialog
                if (!confirm('هل أنت متأكد أنك تريد مغادرة هذه الصفحة؟ قد تفقد التغييرات غير المحفوظة.')) {
                    // If user clicks "Cancel", prevent the default action
                    event.preventDefault();
                }
            }
        });
    }
});
</script>
</body>
</html>
{% endblock %}

